name: Deploy to ECS

on:
   workflow_dispatch
  # workflow_run:
  #   workflows: ["Medusa-CI"]
  #   types:
  #     - completed

jobs:
  deploy:
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Fetch current task definition and create new revision
        run: |
          TASK_NAME="medusa-task"
          IMAGE="mushahid144/mymedusa:v2"
          aws ecs describe-task-definition --task-definition $TASK_NAME > task-def.json

          jq '{
            family: .taskDefinition.family,
            networkMode: .taskDefinition.networkMode,
            executionRoleArn: .taskDefinition.executionRoleArn,
            containerDefinitions: (
              .taskDefinition.containerDefinitions | map(
                .image = "'$IMAGE'"
              )
            ),
            requiresCompatibilities: ["FARGATE"],
            cpu: "1024",
            memory: "2048"
          }' task-def.json > new-task-def.json

          aws ecs register-task-definition --cli-input-json file://new-task-def.json

      - name: Update ECS service to use new task definition
        run: |
          aws ecs update-service \
            --cluster medusa-cluster \
            --service medusa_ecs_service \
            --task-definition medusa-task \
            --force-new-deployment
